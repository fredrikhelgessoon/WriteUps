import hashlib
from pwn import *
import sys
import operator
import random
from numpy import linspace
context.log_level = 'error'

#Hashes words from the wordlist "rockyou.txt" until a hash matching the CAPTCHA-requirement is found.
def breakCaptcha(wanted):
    #Open wordlist in read-mode
    with open("/home/fredrik/Programs/JohnTheRipper/run/Wordlists/rockyou.txt", "r") as file:
        for line in file:
            #Test against CAPTCHA requirement, if first 5 characters of MD5 sum are correct, the word is valid as CAPTCHA
            hashed = hashlib.md5(line.rstrip()).hexdigest()[:5]
            if(hashed==wanted):
                    break
    return line

def approximate(lastMax, grade, nrOfQueries):
    y = {}
    space = linspace(lastMax+grade, lastMax-grade, 21)
    for i in space:
	p.sendline("1")
	nrOfQueries += 1
	p.recvuntil("Enter a float: ")
        p.sendline(str(i))
        value = p.recvline()
        fx, res = value.split(" = ")
        res = float(res[:-1])
        y[i] = res
    return y, nrOfQueries

def guess(minimum, maximum):
    y = {}
    #Used to limit numer of sent queries to the maxlimit 501
    # Rough approximation of global maximum
    rough = linspace(minimum, maximum, (maximum-minimum+1))
    nrOfQueries = 0
    for i in rough:
	p.sendline("1")
	nrOfQueries += 1
	p.recvuntil("Enter a float: ")
        p.sendline(str(i))
        value = p.recvline()
        fx, res = value.split(" = ")
        res = float(res[:-1])
        y[i] = res

    #Extract maximum value found during rough approximation
    rough = max(y.items(), key=operator.itemgetter(1))[0]
    
    grade = 1
    lastMax = rough
    while (nrOfQueries < (500-21)):
	y, nrOfQueries = approximate(lastMax, grade, nrOfQueries)
	grade *= 0.1
	lastMax = max(y.items(), key=operator.itemgetter(1))[0]
    
    result = y[lastMax]
    print "Total Number of queries: ", str(nrOfQueries)
    print "Global Maximum: ", result

    return result
    

#Open connection to remote server
p = remote('199.247.6.180', 14001)
p.recvline()
#Parse md5sum for CAPTCHA-challenge
interesting = p.recvline()
a, b = interesting.split("=")
wanted = b[:-2]

line = breakCaptcha(wanted)
#Send CAPTCHA to remote server
p.sendline(line)

#Parse requested range
p.recvuntil("range ")
targetRange = p.recvuntil(")")[1:-2]
minInt, maxInt = targetRange.split(", ")
result = guess(int(minInt), int(maxInt))
p.sendline("2")
p.recvuntil("Enter your guess: ")
p.sendline(str(result))
p.interactive()
